
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OpenSensors.IO</title>
  <meta name="author" content="OpenSensors.IO">

  
  <meta name="description" content="IOT in the City Mar 12th, 2014 Architecting Internet of Things Software for Cities We are often asked to advise on how best to build scalable &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.opensensors.io">
  <link href="/os.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="OpenSensors.IO" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Poller+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Germania+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fontdiner+Swanky' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cardo' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Sorts+Mill+Goudy' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Della+Respira' rel='stylesheet' type='text/css'>

  

</head>
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<logo>

</logo>



<body 
       
      >
  <header role="banner"><hgroup>
  <h1><a href="http://opensensors.io/">OpenSensors.IO</a></h1>
  
    <h2>News and Updates about OpenSensors.IO</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<br>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.opensensors.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<!--
<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
-->

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/12/iot-in-the-city/">IOT in the City</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-12T13:41:00+00:00" pubdate data-updated="true">Mar 12<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Architecting Internet of Things Software for Cities</h2>

<p>We are often asked to advise on how best to build scalable products for
the Internet of Things, specifically to provide City wide services. City scale projects, also marketed as Smart or Future
Cities, within an IOT context are projects that combine aspects of the physical
and digital worlds to provide infrastructure and
services. Inherently these projects have to tackle the challenge of
scalable software management as well as distributed data management i.e. Big Data.</p>

<p>Among the projects we are involved in are parking management
applications using parking sensors, real time analysis of pollution data from
pollution monitors and using telemetry data to map routes for people with
disabilities.</p>

<p>The problem space that connected devices are used in is diverse but
technologically speaking the architectural model is fairly common. There are usually
a number of different types of sensors each measuring distinct factors
which in turn are listened to by either other devices or
software services. In the parking situation, a connected car can
listen to sensors in a particular area in order to ascertain
the nearest parking availability.  Any serious IOT project will
quickly evolve to having thousands, if not millions, of devices
connected to it.  It will also need to be able to cope with potentially millions of listeners such as the
individual cars in the parking scenario.</p>

<h2>Architectural Model</h2>

<p>We strongly favour the Publish/Subscribe (aka PUB/SUB) model of
building software in IOT.  In pub/sub, &ldquo;Publishers&rdquo; are usually the
devices but can also be data from smart phones and the &ldquo;Subscribers&rdquo; are all the
services that care about the data that the device is emitting.  In the PUB/SUB
model devices can have one or many subscribers and subscribers
can listen to one or many publishers. This is essential when building
systems for Cities.  Let&rsquo;s take the example of pollution monitoring,
there are many potential groups interested in this data from environmental groups to those
concerned by the impact on health.  Each group should be free to build
applications that are relevant to them without being impacted by the
needs of the other subscribers.  You do not want a situation where
each pollution monitor can only talk to one monolytic, and
often proprietary, system thereby needing to set up another pollution monitor on
the same street for each group which is frankly impractical and
wasteful. The PUB/SUB model eliminates this situation.</p>

<p>Scaling this model has been our obsession since the start of
opensensors.IO.  We have open sourced our engine to enable others to
be able to also create scalable services. <a href="https://github.com/OpenSensorsIO/azondi">Azondi</a> is our
<a href="http://opensensors.io/">MQTT</a> based engine to enable processing device data at
scale.</p>

<p>All of this has been possible by standing on the shoulders of giants
using battle test components.  Our MQTT broker relies on <a href="http://netty.io/">Netty</a> in order to provide an extensible
broker.  Netty is used by a host of tech companies to build various
real time systems such as Twitter, Facebook and Avast.  We also rely on
<a href="https://github.com/reactor/reactor">Project Reactor</a> to get a non-blocking
dispatcher for event driven programming based on the
<a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor Pattern</a>. This dispatcher acts as a kind of sorting office between devices and their
listeners. It receives all messages and &lsquo;delivers&rsquo; messages to
interested listeners.</p>

<p>The most important motivation behind the technological choices we made to build
Azondi is the need to avoid polling at all costs. When you have
potentially 100,000s of services listening to each device message you
never want a situation where you are being simultaneously hit by requests.</p>

<h2>Model of a City</h2>

<p>Putting the above theory into a real world model, below is a diagram
on how Azondi would be implemented in reality.  Let us pretend that we are processing device data from
disparate sources for the London Borough of Camden.</p>

<p>In the example, there are environmental monitors that measure
pollution and noise as well as a weather station monitoring temperature and
wind speeds.  In addition, cars send information about traffic
 in their vicinity. On the other hand, Mary&rsquo;s car is listening for local parking
information and Sophie&rsquo;s phone listens to information on noise,
pollution, temperature and energy readings.  Both Mary&rsquo;s car and Sophie
would have the option to filter the information they receive
i.e. local information only or when pollution hits dangerous levels.  Camden Council cares about all of the data sets and
would probably have a dashboard or a decision support system.</p>

<h2>Illustration of Azondi in action</h2>

<p>Click on each device to get it to publish (random) data and watch the
subscribers receive their information.</p>

<iframe src="http://city-model.s3-website-us-east-1.amazonaws.com/#"
height=800px width=900px scrolling = "no"></iframe>



</div>
  
  


    <script type="text/javascript" src="/javascripts/github.js"></script>
    </article>
  
  
  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/25/the-big-red-button/">The Big Red Button</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-25T23:48:00+00:00" pubdate data-updated="true">Nov 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a development harness for my Clojure systems called <a href="https://github.com/juxt/jig?source=c">Jig</a>. Jig has
a feature that allows me to teardown and reinitialize the entire state
of the system, while loading in any code that has changed since the last
reset. It allows for a rapid development experience approaching that of
Smalltalk and LISP systems a few decades ago.</p>

<p>Along with resets, there are other notable signals that are appropriate
for the ceremony of pushing a &lsquo;big red button&rsquo; (besides launching
missiles at your enemy!).</p>

<ul>
<li>signalling that a new code release should be deployed into production</li>
<li>telling your family that dinner is ready</li>
<li>instructing the quadrocopter to ignore all further signals from the
trainee pilot, level off and gracefully descend to the ground</li>
</ul>


<p><img src="/images/Big_Red_Button.jpg" /></p>

<p>The Big Red Button at opensensors was bought from <a href="http://www.dreamcheeky.com/big-red-button">Dream Cheeky</a></p>

<h2>Installing Mosquitto</h2>

<p>As a pre-requisite, we&rsquo;ll need to install an MQTT client.</p>

<p>For this, install <em>mosquitto</em>, an open source MQTT broker which comes
with command-line client tools for publishing messages. Full
instructions are here: <a href="http://mosquitto.org/download/">http://mosquitto.org/download/</a></p>

<h2>Detect button presses in Linux</h2>

<p>The Big Red Button doesn&rsquo;t come with a dedicated Linux driver, so we
must write one. These instructions assume you&rsquo;re using Arch Linux, if
you&rsquo;re using a different distribution then you may have to adjust them
accordingly (file locations may be slightly different).</p>

<h3>Adding the ~/dev/big_red_button~</h3>

<p>First we need to create a Unix =/dev= character device that we can use to
communicate with the Big Red Button.</p>

<p>Plug the big red button into a spare USB port and run the command
=lsusb=. If your big red button is attached, you should an entry like
this :&ndash;</p>

<pre><code>$ lsusb
Bus 001 Device 003: ID 1d34:000d Dream Cheeky Dream Cheeky Big Red Button
</code></pre>

<p>We need to find the =ID_MODEL= of the device. We can do this by running
=udevadm= and try disconnecting and reconnecting the device.</p>

<pre><code># udevadm monitor --environment udev | grep ID_MODEL=
ID_MODEL=DL100B_Dream_Cheeky_Generic_Controller
ID_MODEL=DL100B_Dream_Cheeky_Generic_Controller
ID_MODEL=DL100B_Dream_Cheeky_Generic_Controller
</code></pre>

<p>Or we can find out with the =udevadm= command.</p>

<pre><code># udevadm info /dev/bus/usb/001/003
P: /devices/pci0000:00/0000:00:1a.0/usb1/1-1/1-1.3
N: bus/usb/001/061
S: big_red_button
E: BUSNUM=001
...
E: ID_MODEL=DL100B_Dream_Cheeky_Generic_Controller
</code></pre>

<p>In this case, 001 and 003 correspond to the Bus and Device returned by
=lsusb= respectively.</p>

<p>Now we can pattern match on that udev environment value. As root, create
a file =/etc/udev/rules.d/50-big-red-button.rules= with the following
content, making sure that the ENV{ID_MODEL} entry matches the correct
string that we&rsquo;ve just found using :&ndash;</p>

<pre><code>ACTION=="add", ENV{ID_MODEL}=="DL100B_Dream_Cheeky_Generic_Controller", SYMLINK+="big_red_button", MODE="0666", RUN+="/usr/bin/mosquitto_pub -h mqtt.opensensors.io -t /my/big/red/button -m Add"
ACTION=="remove", ENV{ID_MODEL}=="DL100B_Dream_Cheeky_Generic_Controller", RUN+="/usr/bin/mosquitto_pub -h mqtt.opensensors.io -t /my/big/red/button -m Add"
</code></pre>

<p>This causes a new device to be added, =~/dev/big_red_button~=, with a
mode of 666 so that we can read and write from it without being
root. Also, every time the device is connected and disconnected, MQTT
messages are published to the topic =/my/big/red/button= at
OpenSensorsIO. We&rsquo;ll use this topic for this example, but you should set
this to something unique.</p>

<p>Reload the udev rules with the following command :&ndash;</p>

<pre><code>udevadm control --reload-rules
</code></pre>

<p>To test, disconnect the big red button (pull out the USB plug) and
reconnect it. Each time you do this you should see the device
=~/dev/big_red_button~= disappear and reappear.</p>

<h3>Writing the device driver</h3>

<p>We need to write some simple code to control the device which will print events to standard out.</p>

<p>Copy and paste the following code into a file, for example, =~big-red-button.c~=</p>

<pre><code>/*
,* Copyright © 2013, Malcolm Sparks &lt;malcolm@congreve.com&gt;. All Rights Reserved.
,*
,* A program to convert USB firing events from the Dream Cheeky 'Big Red Button' to MQTT events.
,*/

#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

#define LID_CLOSED 21
#define BUTTON_PRESSED 22
#define LID_OPEN 23

int main(int argc, char **argv)
{
  int fd;
  int i, res, desc_size = 0;
  char buf[256];

  /* Use a udev rule to make this device */
  fd = open("/dev/big_red_button", O_RDWR|O_NONBLOCK);

  if (fd &lt; 0) {
    perror("Unable to open device");
    return 1;
  }

  int prior = LID_CLOSED;

  while (1) {
    memset(buf, 0x0, sizeof(buf));
    buf[0] = 0x08;
    buf[7] = 0x02;

    res = write(fd, buf, 8);
    if (res &lt; 0) {
      perror("write");
      exit(1);
    }

    memset(buf, 0x0, sizeof(buf));
    res = read(fd, buf, 8);

    if (res &gt;= 0) {
      if (prior == LID_CLOSED &amp;&amp; buf[0] == LID_OPEN) {
         printf("Ready to fire!\n");
         fflush(stdout);
      } else if (prior != BUTTON_PRESSED &amp;&amp; buf[0] == BUTTON_PRESSED) {
        printf("Fire!\n");
        fflush(stdout);
      } else if (prior != LID_CLOSED &amp;&amp; buf[0] == LID_CLOSED) {
        printf("Stand down!\n");
        fflush(stdout);
      }
      prior = buf[0];
    }
    usleep(20000); /* Sleep for 20ms*/
  }
}
</code></pre>

<p>Compile the file</p>

<pre><code>$ cc big-red-button.c -o big-red-button
</code></pre>

<p>and run the executable, testing it by opening the lid on your device and pressing the (big red) button (a few times!). You should get output looking a bit like this :&ndash;</p>

<pre><code>$ ./big-red-button
Ready to fire!
Fire!
Fire!
Fire!
Fire!
Stand down!
</code></pre>

<p>If so, great, we now have a functioning device.</p>

<pre><code>$ ./big-red-button | mosquitto_pub -l -h mqtt.opensensors.io -t /my/big/red/button
</code></pre>

<p>Now go to <a href="http://opensensors.io">http://opensensors.io</a> and tune into the topic. Open the lid,
and start pressing the button. If you&rsquo;ve done everything correctly,
you&rsquo;ll see your messages in your browser.</p>

<p>Have fun!</p>
</div>
  
  


    <script type="text/javascript" src="/javascripts/github.js"></script>
    </article>
  
  
  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/08/future-cities/">Future Cities</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-08T13:07:00+01:00" pubdate data-updated="true">Oct 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We were honored to be a platform partner and host the data for <a href="http://futurecitieshackathon.com/">The Future Cities Hackathon: Open Urban Data for The Citizens</a> a collaborative project by <a href="http://datasciencelondon.org/">Data Science London</a> during the weekend of the 5th &ndash; 6th of October.</p>

<p>Granular Data sets where provided by the City of Westminster by street and a period of around a year.
The full list data sets are below:</p>

<ul>
<li>Anti Social Behavior data</li>
<li>Dog fouling</li>
<li>Graffiti</li>
<li>Parking Sensors</li>
<li>Parking Tickets issued</li>
<li>Crowd Dynamics data measuring foot falls once an hour</li>
<li>Parking Cashless transactions data</li>
</ul>


<p>Participants spent the weekend working on projects aimed to improve the experiences of City of Westminster residents.  There were approximately 15 submissions in order to win one of 3 prizes.  The prize categories were for Statistical modelling, Data Visualisation and a Windows phone application.  The quality of the final submissions were outstanding.</p>

<p>A few of the submissions were</p>

<ul>
<li><p>Team &lsquo;Fjölmenni&rsquo;, who won the Statistical modeling challenge, made a &lsquo;CrowdWalk&rsquo; application that predicted how busy streets would be by time and day.</p></li>
<li><p>Team &lsquo;Kung fu pandas&rsquo; made a number of statistical models on parking spaces, one of the most interesting was finding under utilized car parking spaces.</p></li>
</ul>


<p><img src="/images/IMAG0731.jpg" /></p>

<ul>
<li>Team &lsquo;Street Sweep&rsquo; won the best Visualisation catergory and made a fantastic game 3d game using the opensensors.io api and open street map.  The game allowed players to clean dog fouling, vomit, etc from real data</li>
</ul>


<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/jWkxDIYp6sU "></iframe></div>


<p>There were many more amazing projects submitted that could make the lives of people of Westminster so much easier.</p>

<h3>The Problem</h3>

<p>Unfortunately, getting the data in the first place was incredibly difficult.  The painful process and route that it took to get to us was described by Carlos in his talk.  The data was passsed between a multitude of intermediary companies and crossed the Oceans a few times in the below manner</p>

<p>&ldquo;Sensor device >  Data Provider > people > DB > people > ETL > people> CSV > public entity> people > ETL>  IT Vendor> DW > people > CSV > Sharepoint > Dropbox > and… us !!!&rdquo;</p>

<p>This process harms everyone from the council to residents. We can and need to simplify this process.</p>

<p>Smart environments need not be a dream of the distant future if we open the data and enable businesses and developers to build services for the benefit of everyone.</p>
</div>
  
  


    <script type="text/javascript" src="/javascripts/github.js"></script>
    </article>
  
  
  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/07/hello-world/">Hello World</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-07T06:06:00+01:00" pubdate data-updated="true">Oct 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Introducing <a href="http://opensensors.io">OpenSensors.IO</a></h2>

<p>Opensensors.IO is a project by <a href="http://atomicdatalabs.com/">Atomic Data Labs</a> built to simplify large scale publishing and subscribing of device data. We want to make available, under open data licences, the real time and historical data generated by devices all around us.</p>

<p>The motivation for this project is to enable developers and citizens to easily unlock the value of data generated all around us.  This data should be communally shared so that anyone can build services for their communities.</p>

<p>The &lsquo;Smart Cities / Future Cities&rsquo; revolution need not be about expensive infastructure projects that will cost governments millions or even billions to build.  Devices such as Parking Sensors, Energy Consumption devices as well as Pollution monitoring sensors already log and monitor most urban areas. Start ups and developers will be able to build smart applications from data from these devices alone if given the chance to get access to them.</p>

<p><strong>Publishing and Access of data under an <a href="http://www.theodi.org/guide/what-open-data">Open Data Licence</a> will be free to anyone irrespective of the volume of data.</strong></p>

<p>Individuals with a small number of personal devices will also be free to publish their data under a private licence and share with whom they choose.  Contact on &lsquo;<a href="&#109;&#97;&#x69;&#108;&#x74;&#x6f;&#x3a;&#x68;&#101;&#x6c;&#x6c;&#x6f;&#x40;&#111;&#x70;&#x65;&#x6e;&#115;&#x65;&#110;&#x73;&#111;&#x72;&#x73;&#46;&#105;&#111;">&#x68;&#101;&#x6c;&#108;&#111;&#x40;&#x6f;&#x70;&#101;&#x6e;&#115;&#101;&#x6e;&#115;&#x6f;&#114;&#x73;&#x2e;&#105;&#x6f;</a>&rsquo; to join our private beta.</p>
</div>
  
  


    <script type="text/javascript" src="/javascripts/github.js"></script>
    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo">

<p>
  Website copyright &copy; 2014 - OpenSensors.IO |
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> </span>.
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
